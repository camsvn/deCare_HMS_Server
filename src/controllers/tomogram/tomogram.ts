import { Request, Response } from "express";
import jwt from 'jsonwebtoken';

import Locals from '../../providers/Locals'
import Log from '../../middlewares/Log';
import {errorResponse,failResponse,successResponse} from '../../helpers/JSend'

import fs from 'fs';
import {IUserInstance} from '../../models'
import {userDB} from '../../providers/Database'

export const uploadTomogramController = async (req: Request, res: Response) => {
  console.log('FileName', req.files);//this will be automatically set by multer
  console.log('Body', req.body);
  //below code will read the data from the upload folder. Multer will automatically upload the file in that folder with an autogenerated name
  res.send("Success");
  
  // const files = req.files as Express.Multer.File[];
  // files.map(file => {
  //   fs.readFile(file.path ,(err, contents)=> {
  //     if (err) {
  //       console.log('Error: ', err);
  //       res.status(500).json("Invalid File")
  //     } else {
  //     console.log('File contents ',contents);
  //     }
  //   })    
  //   console.log(file);
  // })
  // res.send("Success");
}

export const loginController = async (req: Request, res: Response) => {
    try {
        const {username, password} = req.body;

        if(!(username && password)) {
            return res.status(400).send(failResponse("All inputs are required"));
        }
        const user: IUserInstance = await userDB.UserModel?.findOne({
            attributes: ['id','username', 'password'],
            where: {Username: username }
        });

        if (user && user.password === password) {            
            const token = jwt.sign(
                {user_id: user.id, username},
                Locals.config().appSecret,
                {expiresIn: '2h'}
            );

            return res.status(200).json(successResponse({
                id: user.id,
                username: user.username,
                accessToken: token 
            }));
        } 
        res.status(400).json(failResponse("Invalid Credentials"));
        
    } catch (e: any) {
        Log.error(e.message);
        res.status(500).json(errorResponse("Internal Server Error", e.message));
    }
    
}

export const getloginController = async (req: Request, res: Response) => {
    res.json(successResponse('Route /tomogram/login success'));
}